
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title is now dynamic (will be set by JavaScript on load) -->
    <title id="page-title">Loading Quiz...</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load the external quiz data (allQuizData and quizTitle) before the logic script -->
    <script src="https://aa3025.github.io/leon/quiz1.js"></script>

    <!-- Load MathJax for correct LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script>
        // Configure MathJax to process LaTeX content
        MathJax = {
            tex: {
                // Using \(\) for inline math is more robust in HTML generated from JS strings
                inlineMath: [['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <style>
        /* Custom styles for better readability and a clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .quiz-option:hover {
            background-color: #f1f5f9;
        }
        .correct-answer {
            background-color: #d1fae5; /* Green 100 */
        }
        .incorrect-answer {
            background-color: #fee2e2; /* Red 100 */
        }
        .explanation-box {
            white-space: pre-wrap; /* Preserve formatting in explanations */
        }
        /* Ensure MathJax content is easy to read */
        .MathJax {
            font-size: 1.1rem; 
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10 relative">
        <!-- Debug Toggle Checkbox in the top right corner -->
        <div class="absolute top-4 right-4 flex items-center space-x-2">
            <label for="debug-toggle" class="text-sm text-gray-600 font-medium select-none">Show Debug</label>
            <input type="checkbox" id="debug-toggle" onchange="toggleDebug()" class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
        </div>

        <!-- The h1 title now has an ID and is initially generic to be set by JavaScript -->
        <h1 id="quiz-header" class="text-3xl font-bold text-gray-800 mb-2">Loading Quiz...</h1>
        
        <!-- Dropdown for selecting number of questions -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between text-lg text-gray-600 mb-8 border-b pb-4">
            <p class="mb-2 sm:mb-0">Select all correct options for each question.</p>
            <div class="flex items-center space-x-2">
                <label for="question-count" class="text-base font-medium text-gray-700">Questions to show:</label>
                <select id="question-count" onchange="loadNewQuizSet(this.value)" class="p-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base">
                    <option value="5" selected>5 Questions</option>
                    <option value="10">10 Questions</option>
                    <option value="15">15 Questions (All)</option>
                </select>
            </div>
        </div>
        <!-- End Dropdown -->

        <!-- DEBUG STATUS MESSAGE BOX - Initially hidden using 'hidden' class -->
        <div id="debug-status" class="mb-6 p-3 bg-yellow-100 border border-yellow-300 text-sm text-yellow-800 rounded-lg shadow-inner hidden">
            Debug Status: Awaiting action...
        </div>
        <!-- END DEBUG STATUS MESSAGE BOX -->

        <div id="quiz-container">
            <!-- Questions will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        // Store the current number of questions to load (default is 5)
        let questionCount = 5; 
        
        // NOTE: allQuizData and optionally quizTitle are expected to be loaded from quiz3.js
        
        // --- UTILITY FUNCTION FOR RANDOMIZATION ---
        /**
         * Shuffles an array in place using the Fisher-Yates algorithm.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Loads a new set of questions based on the selected count and re-renders the quiz.
         * @param {string} count - The number of questions to load (5, 10, or 15).
         */
        function loadNewQuizSet(count) {
            questionCount = parseInt(count, 10);
            renderQuiz();
            
            // Optional: Update debug status
            const debugStatus = document.getElementById('debug-status');
            if (debugStatus && !debugStatus.classList.contains('hidden')) {
                debugStatus.textContent = `Quiz reloaded. Now showing ${questionCount} random questions.`;
            }
        }
        
        // --- CORE QUIZ RENDERING LOGIC ---
        function renderQuiz() {
            // Check if data is available (loaded from quiz3.js)
            if (typeof allQuizData === 'undefined' || !Array.isArray(allQuizData) || allQuizData.length === 0) {
                const container = document.getElementById('quiz-container');
                container.innerHTML = '<div class="text-center p-12 bg-red-50 border border-red-300 rounded-lg"><h2 class="text-xl font-bold text-red-800">Error: Quiz data not loaded.</h2><p class="text-red-700 mt-2">Please ensure <code>quiz3.js</code> is present and defines the <code>allQuizData</code> array.</p></div>';
                
                // If data is missing, still try to update the title if it was provided alone
                const defaultTitle = "Error Loading Quiz";
                const currentQuizTitle = (typeof quizTitle !== 'undefined' && quizTitle) ? quizTitle : defaultTitle;
                document.getElementById('page-title').textContent = currentQuizTitle;
                document.getElementById('quiz-header').textContent = currentQuizTitle;
                
                return;
            }
            
            // --- NEW: Dynamic Title Loading ---
            const defaultTitle = "Generic MSQ Quiz";
            // Check for a global variable 'quizTitle' expected from quiz3.js
            const currentQuizTitle = (typeof quizTitle !== 'undefined' && quizTitle) ? quizTitle : defaultTitle;

            // Update the page title (browser tab) and the main header (on the page)
            document.getElementById('page-title').textContent = currentQuizTitle;
            document.getElementById('quiz-header').textContent = currentQuizTitle;
            // --- END: Dynamic Title Loading ---


            const container = document.getElementById('quiz-container');
            
            // 1. Shuffle all questions and select the number defined by questionCount
            const selectedQuestions = shuffleArray([...allQuizData]).slice(0, questionCount); // Use spread to shuffle a copy

            container.innerHTML = selectedQuestions.map((q, index) => `
                <div id="question-${q.id}" class="mb-10 p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-sm relative">
                    <!-- Reset Button with Unicode Symbol ♲ -->
                    <button onclick="resetQuestion(${q.id})" 
                            title="Reset Question"
                            class="absolute top-4 right-4 p-1 rounded-full text-gray-400 hover:text-indigo-600 hover:bg-gray-100 transition duration-150 text-xl font-bold leading-none">
                        <span class="block">♲</span>
                    </button>
                    <!-- End Reset Button -->

                    <!-- Question number uses the current index (1 to questionCount) -->
                    <p class="text-xl font-semibold mb-4 text-gray-700">Q${index + 1}: ${q.question}</p>
                    <div class="space-y-3">
                        ${q.options.map((option, optIndex) => `
                            <label class="flex items-center p-3 rounded-lg bg-white shadow-sm border border-gray-100 quiz-option cursor-pointer transition duration-150 ease-in-out" for="q${q.id}o${optIndex}">
                                <input type="checkbox" id="q${q.id}o${optIndex}" name="q${q.id}" value="${optIndex}" class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="ml-3 text-base text-gray-800">${String.fromCharCode(65 + optIndex)}. ${option}</span>
                            </label>
                        `).join('')}
                    </div>

                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button onclick="checkAnswer(${q.id})" class="check-btn-${q.id} w-full sm:w-1/3 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">
                            Check Answer
                        </button>
                        <!-- Show Answer button, initially disabled -->
                        <button onclick="revealAnswers(${q.id})" disabled class="show-answer-btn-${q.id} w-full sm:w-1/3 px-4 py-2 font-semibold rounded-lg shadow-md transition duration-200 
                            bg-gray-300 text-gray-700 opacity-50 cursor-not-allowed">
                            Show Answer
                        </button>
                        <!-- Explain button is now initially disabled (gray) -->
                        <button onclick="showExplanation(${q.id})" disabled class="explain-btn-${q.id} w-full sm:w-1/3 px-4 py-2 font-semibold rounded-lg shadow-md transition duration-200 
                            bg-gray-300 text-gray-700 opacity-50 cursor-not-allowed">
                            Explain
                        </button>
                    </div>

                    <div id="explanation-${q.id}" class="explanation-box mt-6 p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm text-gray-700 hidden">
                        <p class="font-bold text-blue-800 mb-2">Explanation:</p>
                        ${q.explanation}
                    </div>
                </div>
            `).join('');

            // After rendering the HTML, ask MathJax to process the math content
            // Need to wait for MathJax to be loaded before calling typesetPromise
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch(err => console.error("MathJax typesetting failed: ", err));
            }
        }

        /**
         * Toggles the visibility of the debug status box based on the checkbox state.
         */
        function toggleDebug() {
            const debugBox = document.getElementById('debug-status');
            const toggle = document.getElementById('debug-toggle');

            if (toggle.checked) {
                debugBox.classList.remove('hidden');
            } else {
                debugBox.classList.add('hidden');
            }
        }

        /**
         * Resets the specified question to its default, unanswered state.
         * @param {number} questionId - The ID of the question to reset.
         */
        function resetQuestion(questionId) {
            // Ensure allQuizData is accessible
            if (typeof allQuizData === 'undefined') return;

            // Find the data for the specific question ID
            const questionData = allQuizData.find(q => q.id === questionId);
            if (!questionData) return;
            
            // DEBUGGING
            const debugStatus = document.getElementById('debug-status');
            if (!debugStatus.classList.contains('hidden')) {
                debugStatus.textContent = `Resetting Question ID ${questionId} via Recycle icon.`;
            }

            const questionElement = document.getElementById(`question-${questionId}`);
            if (!questionElement) return; // Guard for safety

            const labels = questionElement.querySelectorAll('label.quiz-option');
            const checkboxes = questionElement.querySelectorAll(`input[name="q${questionId}"]`);
            const checkButton = questionElement.querySelector(`.check-btn-${questionId}`);
            const showAnswerButton = questionElement.querySelector(`.show-answer-btn-${questionId}`); 
            const explainButton = questionElement.querySelector(`.explain-btn-${questionId}`);
            const explanationBox = document.getElementById(`explanation-${questionId}`);

            // 1. Reset options (uncheck and remove highlights/borders)
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            labels.forEach(label => {
                label.classList.remove('correct-answer', 'incorrect-answer');
                label.style.border = '1px solid #e5e7eb'; // Default border
            });
            
            // 2. Reset Check Button to original state
            checkButton.textContent = "Check Answer";
            checkButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
            checkButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            checkButton.disabled = false;
            checkButton.setAttribute('onclick', `checkAnswer(${questionId})`);

            // 3. Reset Show Answer, Explain Button, and Explanation
            showAnswerButton.textContent = 'Show Answer';
            showAnswerButton.disabled = true;
            showAnswerButton.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
            showAnswerButton.classList.add('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
            showAnswerButton.style.opacity = '0.5';
            showAnswerButton.style.backgroundColor = ''; 

            explainButton.textContent = 'Explain';
            explainButton.disabled = true;
            explainButton.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
            explainButton.classList.add('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
            explainButton.style.opacity = '0.5';
            explainButton.style.backgroundColor = ''; 
            
            explanationBox.classList.add('hidden');

            // Re-render math if necessary (though MathJax usually handles hidden/shown content)
            if (window.MathJax) {
                MathJax.typesetPromise([questionElement]).catch(err => console.error("MathJax re-typesetting failed: ", err));
            }
        }

        /**
         * Highlights correct answers and enables the explanation button.
         * This is called when the user selects 'Show Answer'.
         * @param {number} questionId - The ID of the question to reveal.
         */
        function revealAnswers(questionId) {
            // Ensure allQuizData is accessible
            if (typeof allQuizData === 'undefined') return;

            const questionData = allQuizData.find(q => q.id === questionId);
            if (!questionData) return;

            const questionElement = document.getElementById(`question-${questionId}`);
            const labels = questionElement.querySelectorAll('label.quiz-option');
            const showAnswerButton = questionElement.querySelector(`.show-answer-btn-${questionId}`);
            const explainButton = questionElement.querySelector(`.explain-btn-${questionId}`);

            // 1. Highlight Correct Answers
            labels.forEach((label, index) => {
                const isOptionCorrect = questionData.correct.includes(index);
                
                // Ensure incorrect-answer highlight (red) is removed if present if it was selected
                label.classList.remove('incorrect-answer'); 
                
                if (isOptionCorrect) {
                    // Highlight all correct answers
                    label.classList.add('correct-answer');
                    label.style.border = '2px solid #34d399'; // Green border
                }
            });
            
            // 2. Disable "Show Answer" button
            showAnswerButton.disabled = true;
            showAnswerButton.textContent = 'Answers Shown';
            showAnswerButton.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
            showAnswerButton.classList.add('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
            showAnswerButton.style.opacity = '0.5';
            showAnswerButton.style.backgroundColor = '';

            // 3. Enable Explain Button and apply active styling
            explainButton.disabled = false;
            explainButton.textContent = 'Explain'; 
            
            explainButton.classList.remove('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
            explainButton.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
            explainButton.style.opacity = '1';
            explainButton.style.backgroundColor = '#2563eb';
            
            const debugStatus = document.getElementById('debug-status');
            // Only update debug status if debug mode is active
            if (!debugStatus.classList.contains('hidden')) {
                debugStatus.textContent = `Answers revealed for Question ID ${questionId}. Explanation button enabled.`;
            }
        }


        function checkAnswer(questionId) {
            // Ensure allQuizData is accessible
            if (typeof allQuizData === 'undefined') return;

            const questionData = allQuizData.find(q => q.id === questionId);
            if (!questionData) return;

            // DEBUGGING: Update the status message box to confirm execution
            const debugStatus = document.getElementById('debug-status');

            const questionElement = document.getElementById(`question-${questionId}`);
            if (!questionElement) return; // Guard for safety

            const checkboxes = questionElement.querySelectorAll(`input[name="q${questionId}"]:checked`);
            const labels = questionElement.querySelectorAll('label.quiz-option');

            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            let isCorrect = true;

            // 1. Check if the set of selected answers matches the set of correct answers
            if (selectedIndices.length !== questionData.correct.length ||
                !questionData.correct.every(index => selectedIndices.includes(index))) {
                isCorrect = false;
            }

            // 2. Visual Feedback (Highlighting)
            labels.forEach((label, index) => {
                const isOptionSelected = selectedIndices.includes(index);
                const isOptionCorrect = questionData.correct.includes(index);

                // Reset classes and default border
                label.classList.remove('correct-answer', 'incorrect-answer');
                label.style.border = '1px solid #e5e7eb'; 

                if (isCorrect) {
                    // If the answer is correct, highlight ALL correct options green immediately
                    if (isOptionCorrect) {
                        label.classList.add('correct-answer');
                        label.style.border = '2px solid #34d399'; // Green border
                    }
                } else {
                    // If the answer is incorrect, ONLY highlight selected INCORRECT options red
                    if (isOptionSelected && !isOptionCorrect) {
                        label.classList.add('incorrect-answer');
                        label.style.border = '2px solid #f87171'; // Red border
                    }
                    // Correct answers are intentionally NOT highlighted yet.
                }
            });

            // 3. Update Button States
            const checkButton = questionElement.querySelector(`.check-btn-${questionId}`);
            const showAnswerButton = questionElement.querySelector(`.show-answer-btn-${questionId}`);
            const explainButton = questionElement.querySelector(`.explain-btn-${questionId}`);
            
            // Remove previous check button styling classes
            checkButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
            
            // Always reset the explain and show answer buttons to disabled state initially for logic below
            [showAnswerButton, explainButton].forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                btn.classList.add('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
                btn.style.opacity = '0.5';
                btn.style.backgroundColor = '';
                btn.textContent = (btn === showAnswerButton) ? 'Show Answer' : 'Explain';
            });
            
            if (isCorrect) {
                // Correct: Show success, disable check button, and enable explain button immediately.
                checkButton.textContent = "✅ Correct!";
                checkButton.classList.add('bg-green-600', 'hover:bg-green-700');
                checkButton.disabled = true; 
                checkButton.setAttribute('onclick', ''); 
                
                // Enable Explain button immediately upon correct answer
                explainButton.disabled = false;
                explainButton.classList.remove('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
                explainButton.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                explainButton.style.opacity = '1';
                explainButton.style.backgroundColor = '#2563eb';

                // Only update debug status if debug mode is active
                if (!debugStatus.classList.contains('hidden')) {
                    debugStatus.textContent = `Check Answer executed for Question ID ${questionId}. Status: Correct! Explanation enabled.`;
                }
            } else {
                // Incorrect: Show 'Try Again', keep check button enabled, change action to resetQuestion, and ENABLE Show Answer button.
                checkButton.textContent = "❌ Try Again";
                checkButton.classList.add('bg-red-600', 'hover:bg-red-700');
                checkButton.disabled = false;
                checkButton.setAttribute('onclick', `resetQuestion(${questionId})`);
                
                // Enable Show Answer button
                showAnswerButton.disabled = false;
                showAnswerButton.classList.remove('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
                showAnswerButton.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                showAnswerButton.style.opacity = '1';
                showAnswerButton.style.backgroundColor = '#2563eb';
                
                // Only update debug status if debug mode is active
                if (!debugStatus.classList.contains('hidden')) {
                    debugStatus.textContent = `Check Answer executed for Question ID ${questionId}. Status: Incorrect. Try Again or Show Answer enabled.`;
                }
            }
        }

        function showExplanation(questionId) {
            const explanationBox = document.getElementById(`explanation-${questionId}`);
            const explainButton = document.querySelector(`.explain-btn-${questionId}`);
            if (!explanationBox || !explainButton) return;

            if (explanationBox.classList.contains('hidden')) {
                explanationBox.classList.remove('hidden');
                explainButton.textContent = 'Hide Explanation';
            } else {
                explanationBox.classList.add('hidden');
                explainButton.textContent = 'Explain';
            }
        }

        // Initialize the quiz when the window loads
        window.onload = renderQuiz;
    </script>
</body>
</html>
